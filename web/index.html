<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IPFS Check</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Tailwind CSS CDN -->
    <link rel="stylesheet" href="output.css">
    <link rel="canonical" href="https://check.ipfs.network/">
</head>
<body class="font-sans bg-gray-50 text-gray-900 m-0">
<header>
    <h1 class="inline-block px-3 py-3 m-0 leading-tight">
        <a class="no-underline block text-lg font-bold text-gray-900" href="https://ipfs.io">IPFS <span class="text-ipfs-teal-500 font-semibold">Check</span></a>
        <span class="block text-xs font-semibold text-gray-600">Have you seen my CID?</span>
    </h1>
</header>
<main>
    <section class="max-w-3xl mx-auto leading-relaxed text-gray-800 px-2 pb-8">
        <h2 class="m-0 py-0 px-2 text-xl font-bold">
            Check the retrievability of data by CID
        </h2>
        <p class="m-0 py-0 mt-2 px-2 text-lg font-normal">
            Paste in a Content ID and the multiaddr (optional) of a host to check if it is expected to be retrievable
        </p>
    </section>
    <section class="bg-white">
        <form id="queryForm" class="max-w-4xl mx-auto leading-relaxed text-gray-800 rounded-lg py-8 px-2 md:px-8">
            <label class="block mt-3 text-xs font-bold" for="cid">CID or multihash</label>
            <input class="block w-full p-2 border border-gray-300 rounded" type="text" id="cid" name="cid" required>
            <label class="block mt-3 text-xs font-bold" for="ma">Multiaddr (optional)</label>
            <input class="block w-full p-2 border border-gray-300 rounded" type="text" id="multiaddr" name="multiaddr" placeholder="/p2p/12D3Koo..." />
            <details class="mt-3">
                <summary class="text-xs font-bold">Backend Config</summary>
                <label class="block mt-3 text-xs font-bold" for="backendURL">Backend URL</label>
                <input class="block w-full p-2 border border-gray-300 rounded" type="url" id="backendURL" name="backendURL" value="https://ipfs-check-backend.ipfs.io" placeholder="https://ipfs-check-backend.ipfs.io" list="defaultBackendURLs" required>
                <datalist id="defaultBackendURLs">
                    <option value="https://ipfs-check-backend.ipfs.io">
                </datalist>
                <label class="block mt-3 text-xs font-bold" for="ipniIndexer">IPNI Indexer</label>
                <input class="block w-full p-2 border border-gray-300 rounded" type="url" id="ipniIndexer" name="ipniIndexer" value="https://cid.contact" placeholder="https://cid.contact" list="defaultIndexers" required>
                <datalist id="defaultIndexers">
                    <option value="https://cid.contact">
                </datalist>
                <div class="mt-3">
                    <label class="block text-xs font-bold" for="timeoutSeconds">Check Timeout (seconds)</label>
                    <input class="block w-full mt-2" type="range" id="timeoutSeconds" name="timeoutSeconds" min="5" max="300" value="60" step="1">
                    <output class="block font-bold text-xs" for="timeoutSeconds" id="timeoutValue">60</output>
                </div>
                <label class="inline-block mt-3 mr-3 text-xs font-bold" for="httpRetrieval">Check HTTP retrieval</label>
                <input class="inline-block p-2" type="checkbox" id="httpRetrieval" name="httpRetrieval" checked>
            </details>
            <div class="block my-6">
                <button id="submit" type="submit" class="flex items-center px-6 py-2 no-underline cursor-pointer shadow transition bg-ipfs-navy-800 hover:bg-ipfs-navy-900 text-white font-bold text-lg border-0 rounded">
                  <svg id="loading-spinner" class="hidden animate-spin mr-2 h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-20" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-80" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Run Test
                </button>
            </div>
            <div id="output" class="leading-relaxed font-medium"></div>
            <details class="mt-3">
              <summary class="text-xs font-bold">Raw Output</summary>
              <div class="bg-gray-900 text-green-200 rounded p-4 overflow-x-auto mt-2">
                <pre style="white-space:pre;" class="leading-relaxed font-medium language-json"><code id="raw-output"></code></pre>
              </div>
            </details>
        </form>
    </section>
    <section class="max-w-4xl mx-auto leading-relaxed text-gray-800 py-8 px-2 md:px-8">
        <h2 class="text-xl font-bold">Where do I find my multiaddr?</h2>
        <ul class="list-disc ml-6">
            <li class="pb-2">
                <strong>Using IPFS Desktop or IPFS WebUI</strong>
                <ul class="list-disc ml-6">
                    <li>Open the IPFS WebUI "Status" page via the IPFS Desktop menu or by visiting "http://127.0.0.1:5001/webui" (when using the default config settings)</li>
                    <li>If you want to test your peerID rather than a particular address enter <code class="bg-gray-100 px-1 rounded">/p2p/{YourPeerID}</code></li>
                    <li>If you want to test a particular address then click the "Advanced" dropdown to see the node's addresses</li>
                </ul>
            </li>
            <li class="pb-2">
                <strong>Using the kubo CLI</strong>
                <ul class="list-disc ml-6">
                    <li>If you want to test your peerID rather than a particular address run <code class="bg-gray-100 px-1 rounded">ipfs id</code> and enter <code class="bg-gray-100 px-1 rounded">/p2p/{YourPeerID}</code></li>
                    <li>If you want to test a particular address then choose an entry from the list of addresses output by <code class="bg-gray-100 px-1 rounded">ipfs id</code></li>
                </ul>
            </li>
        </ul>
        <h2 class="text-xl font-bold mt-8">What does it mean if I get an error?</h2>
        <ul class="list-disc ml-6">
            <li class="pb-2">
                <strong>Could not connect to the multiaddr</strong>. Machines on the internet cannot talk to your machine.
                Fix your firewall, add port forwarding, or use a relay.
            </li>
            <li class="pb-2">
                <strong>Could not find address in the dht</strong>. Your machine is either not connected to the IPFS Public DHT
                (even as a client), or is not advertising the address that you are testing with. As a result no one will be
                able to contact you on that address if they only learn about your peerID, as is the case for content
                advertised in the IPFS Public DHT
            </li>
            <li class="pb-2">
                <strong>Multihash not advertised in the dht</strong>. Your machine has not advertised that it has the given content in the
                IPFS Public DHT. This means that other machines will have to discover that you have the content in some other
                way (e.g. pre-connecting to you optimistically, pre-connecting to you since related content is already
                advertised by you, some rendezvous service, being on the same LAN, etc.). If using kubo consider enabling the
                <a class="text-blue-600 underline" href="https://github.com/ipfs/kubo/blob/master/docs/experimental-features.md#accelerated-dht-client">Accelerated DHT Client</a>,
				which will advertise content faster and in particular should enable you to continue to republish your advertisements every 24hrs as
				required by the network.
            </li>
            <li class="pb-2">
                <strong>Peer has not responded that it has the CID</strong>. Your node does not think it has the data you think it does,
                or it took too long to respond. Until this is resolved other machines will be unable to download that
                content from you.
            </li>
        </ul>
    </section>
</main>
<footer class="text-center py-3">
    <a class="text-blue-600 underline" href="https://github.com/ipfs/ipfs-check">Github</a>
</footer>
<style>
      .animate-spin { animation: spin 2s linear infinite }

      @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }
    button:disabled {
        opacity: 50% !important;
    }
</style>
<script>
    window.addEventListener('load', function () {
        initFormValues(new URL(window.location))


        document.getElementById('queryForm').addEventListener('submit', async function (e) {
            e.preventDefault() // dont do a browser form post

            showOutput('') // clear out previous results
            showRawOutput('') // clear out previous results

            const formData = new FormData(document.getElementById('queryForm'))
            const backendURL = getBackendUrl(formData)

            showInQuery(formData) // add `cid` and `multiaddr` to local url query to make it shareable
            toggleSubmitButton()
            try {
              const res = await fetch(backendURL, { method: 'POST' })

              if (res.ok) {
                  const respObj = await res.json()
                  showRawOutput(JSON.stringify(respObj, null, 2))

                  if(formData.get('multiaddr') == '') {
                    const output = formatJustCidOutput(respObj)
                    showOutput(output)
                  } else {
                    const output = formatMaddrOutput(formData.get('multiaddr'), respObj)
                    showOutput(output)
                  }
              } else {
                  const resText = await res.text()
                  showOutput(`⚠️ backend returned an error: ${res.status} ${resText}`)
              }
            } catch (e) {
              console.log(e)
              showOutput(`⚠️ backend error: ${e}`)
            } finally {
              toggleSubmitButton()
            }
        })
    })

    function initFormValues (url) {
        for (const [key, val] of url.searchParams) {
            document.getElementById(key)?.setAttribute('value', val)
        }

        const timeoutSlider = document.getElementById('timeoutSeconds')
        const timeoutValue = document.getElementById('timeoutValue')

        timeoutSlider.addEventListener('input', function() {
          timeoutValue.textContent = this.value
        })
        // set initial value
        timeoutValue.textContent = timeoutSlider.value
    }

    function showInQuery (formData) {
        const defaultBackendUrl = document.getElementById('backendURL').getAttribute('placeholder')
        const params = new URLSearchParams(formData)
        // skip showing default value our shareable url
        if (params.get('backendURL') === defaultBackendUrl) {
            params.delete('backendURL')
        }
        const url = new URL('?' + params, window.location)
        history.replaceState(null, "", url)
    }

    function getBackendUrl (formData) {
        const params = new URLSearchParams(formData)
        // dont send backendURL to the backend!
        params.delete('backendURL')
        // backendURL is the base, params are appended as query string
        return new URL('/check?' + params, formData.get('backendURL'))
    }

    function showOutput (output) {
        const outObj = document.getElementById('output')
        outObj.innerHTML = output
    }

    function showRawOutput (output) {
        const outObj = document.getElementById('raw-output')
        outObj.textContent = output
    }

    function toggleSubmitButton() {
        const button = document.getElementById('submit')
        button.toggleAttribute('disabled')
        const spinner = document.getElementById('loading-spinner')
        // Toggle spinner visibility
        spinner.classList.toggle('hidden')
    }

    // SVG icons for status
    const iconCheck = `<svg class="inline w-5 h-5 text-green-500 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>`
    const iconCross = `<svg class="inline w-5 h-5 text-red-500 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>`
    const iconInfo = `<svg class="inline w-5 h-5 text-blue-500 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01"/></svg>`

    function formatMaddrOutput (multiaddr, respObj) {
        const peerIDStartIndex = multiaddr.lastIndexOf("/p2p/")
        const peerID = multiaddr.slice(peerIDStartIndex + 5);
        const addrPart = multiaddr.slice(0, peerIDStartIndex);
        let outHtml = `<div class='space-y-4'>`

        // Connection status
        if (respObj.ConnectionError !== "") {
            outHtml += `<div class='bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded flex gap-x-2 items-center'>${iconCross}<span>Could not connect to multiaddr: <span class='font-mono'>${respObj.ConnectionError}</span></span></div>`
        } else {
            const madrs = respObj?.ConnectionMaddrs
            outHtml += `<div class='bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded flex gap-x-2 items-center'>${iconCheck}<span>Successfully connected to multiaddr${madrs?.length > 1 ? 's' : '' }:<br><span class='font-mono text-xs block ml-6'>${madrs.join('<br>')}</span></span></div>`
        }

        // DHT status
        if (multiaddr.indexOf("/p2p/") === 0 && multiaddr.lastIndexOf("/") === 4) {
            // only peer id passed with /p2p/PeerID
            if (Object.keys(respObj.PeerFoundInDHT).length === 0) {
                outHtml += `<div class='bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded flex gap-x-2 items-center'>${iconCross}<span>Could not find any multiaddrs in the DHT</span></div>`
            } else {
                outHtml += `<div class='bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded flex gap-x-2 items-center'>${iconCheck}<span>Found multiaddrs advertised in the DHT:<br><span class='font-mono text-xs block ml-6'>${Object.keys(respObj.PeerFoundInDHT).join('<br>')}</span></span></div>`
            }
        } else {
            // a proper maddr with an IP was passed
            let foundAddr = false
            for (const key in respObj.PeerFoundInDHT) {
                if (key === addrPart) {
                    foundAddr = true
                    outHtml += `<div class='bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded flex gap-x-2 items-center'>${iconCheck}<span>Found multiaddr with <span class='font-bold'>${respObj.PeerFoundInDHT[key]}</span> DHT peers</span></div>`
                    break
                }
            }
            if (!foundAddr) {
                let alt = ''
                if (Object.keys(respObj.PeerFoundInDHT).length > 0) {
                  alt = `<br>Instead found:<br><span class='font-mono text-xs block ml-6'>${Object.keys(respObj.PeerFoundInDHT).join('<br>')}</span>`
                } else {
                  alt = '<br>No other addresses were found.'
                }
                outHtml += `<div class='bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded flex gap-x-2 items-center'>${iconCross}<span>Could not find the given multiaddr in the DHT.${alt}</span></div>`
            }
        }

        // Provider record
        if (respObj.ProviderRecordFromPeerInDHT === true || respObj.ProviderRecordFromPeerInIPNI === true) {
            outHtml += `<div class='bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded flex gap-x-2 items-center'>${iconCheck}<span>Found multihash advertised in <span class='font-bold'>${respObj.ProviderRecordFromPeerInDHT ? 'DHT' : 'IPNI'}</span></span></div>`
        } else {
            outHtml += `<div class='bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded flex gap-x-2 items-center'>${iconCross}<span>Could not find the multihash in DHT or IPNI</span></div>`
        }

        // Bitswap
        if (respObj.DataAvailableOverBitswap.Enabled === true) {
          if (respObj.DataAvailableOverBitswap.Error !== "") {
              outHtml += `<div class='bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded flex items-center'>${iconCross}<span>There was an error downloading the CID from the peer via Bitswap: <span class='font-mono'>${respObj.DataAvailableOverBitswap.Error}</span></span></div>`
          } else if (respObj.DataAvailableOverBitswap.Responded !== true) {
              outHtml += `<div class='bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded flex items-center'>${iconCross}<span>The peer did not quickly respond if it had the CID over Bitswap</span></div>`
          } else if (respObj.DataAvailableOverBitswap.Found === true) {
              outHtml += `<div class='bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded flex items-center'>${iconCheck}<span>The peer responded that it has the CID over Bitswap</span></div>`
          } else {
              outHtml += `<div class='bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded flex items-center'>${iconCross}<span>The peer responded that it does not have the CID over Bitswap</span></div>`
          }
        }

        // HTTP
        if (respObj.DataAvailableOverHTTP.Enabled === true) {
          if (respObj.DataAvailableOverHTTP.Error !== "") {
              outHtml += `<div class='bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded flex items-center'>${iconCross}<span>There was an error downloading the CID via HTTP: <span class='font-mono'>${respObj.DataAvailableOverHTTP.Error}</span></span></div>`
          }

          if (respObj.DataAvailableOverHTTP.Connected !== true) {
              outHtml += `<div class='bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded flex items-center'>${iconCross}<span>HTTP connection was unsuccessful to the HTTP endpoint</span></div>`
          } else if (respObj.DataAvailableOverHTTP.Found === true) {
              outHtml += `<div class='bg-green-100 border-l-4 border-green-500 text-green-700 p-4 rounded flex items-center'>${iconCheck}<span>The HTTP endpoint responded that it has the CID</span></div>`
          } else {
              outHtml += `<div class='bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded flex items-center'>${iconCross}<span>The HTTP endpoint responded that it does not have the CID</span></div>`
          }
        }
        outHtml += '</div>'
        return outHtml
    }

    function formatJustCidOutput (resp) {
        if (resp.length === 0) {
            return `<div class='bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded flex items-center'>${iconCross}<span>No providers found for the given CID</span></div>`
        }

        const successfulProviders = resp.reduce((acc, provider) => {
            if(provider.ConnectionError === '' && (provider.DataAvailableOverBitswap?.Found === true || provider.DataAvailableOverHTTP.Found === true)) {
                acc++
            }
            return acc
        }, 0)

        // Show providers with the data first, followed by reachable providers, then by those with addresses
        resp.sort((a, b) => {
            const aHasData = a.DataAvailableOverBitswap?.Found || a.DataAvailableOverHTTP?.Found
            const bHasData = b.DataAvailableOverBitswap?.Found || b.DataAvailableOverHTTP?.Found

            // First order by data availability
            if (aHasData && !bHasData) return -1
            if (!aHasData && bHasData) return 1

            const aHasBitswap = a.DataAvailableOverBitswap?.Enabled
            const bHasBitswap = b.DataAvailableOverBitswap?.Enabled

            // Then order HTTP first
            if (aHasBitswap && !bHasBitswap) return 1
            if (!aHasBitswap && bHasBitswap) return -1


            const aSource = a.Source
            const bSource = b.Source

            // Then order Amino DHT first
            if (aSource === 'IPNI' && bSource !== 'IPNI') return 1
            if (aSource !== 'IPNI' && bSource === 'IPNI') return -1

            // Then order by connection errors
            if (a.ConnectionError === '' && b.ConnectionError !== '') {
                return -1;
            } else if (a.ConnectionError !== '' && b.ConnectionError === '') {
                return 1;
            }

            // Finally, show providers with addresses first
            if(a.Addrs?.length > 0 && b.Addrs?.length === 0) {
                return -1
            } else if(a.Addrs?.length === 0 && b.Addrs?.length > 0) {
                return 1
            }

            return 0
        })

        let outHtml = `<div class='mb-4'><span class='text-lg font-bold'>${successfulProviders > 0 ? iconCheck : iconCross} Found ${successfulProviders} working providers</span> <span class='text-gray-600'>(out of ${resp.length} provider records sampled from Amino DHT and IPNI) that could be connected to and had the CID available over Bitswap:</span></div>`
        outHtml += `<div class='grid gap-4 grid-cols-1'>`
        for (const provider of resp) {
            const couldConnect = provider.ConnectionError === ''
            const hasBitswap = provider.DataAvailableOverBitswap?.Enabled === true
            const hasHTTP = provider.DataAvailableOverHTTP?.Enabled === true
            const foundBitswap = provider.DataAvailableOverBitswap?.Found
            const foundHTTP = provider.DataAvailableOverHTTP?.Found
            const isUnsuccessful = !couldConnect || (!foundBitswap && !foundHTTP)
            const cardBg = isUnsuccessful ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200'
            outHtml += `<div class='rounded-lg shadow ${cardBg} p-4 border'>`
            outHtml += `<div class='flex justify-between items-center mb-2'>`
            outHtml += `<span class='font-mono text-xs bg-gray-100 px-2 py-1 rounded mr-2 break-all'>${provider.ID}</span>`
            if (hasBitswap) outHtml += `<span class='ml-2 px-2 py-1 rounded bg-green-100 text-green-700 text-xs font-bold'>Bitswap</span>`
            if (hasHTTP) outHtml += `<span class='ml-2 px-2 py-1 rounded bg-blue-100 text-blue-700 text-xs font-bold'>HTTP</span>`
            if (provider?.Source != null) {
                const bgColor = provider.Source === 'IPNI' ? 'bg-orange-100 text-orange-700' : 'bg-purple-100 text-purple-700'
                outHtml += `<span class='ml-2 px-2 py-1 rounded ${bgColor} text-xs font-bold'>${provider.Source}</span>`
            }
            outHtml += `</div>`
            if (hasBitswap) {
                outHtml += `<div class='flex items-center text-sm mb-1'>${couldConnect ? iconCheck : iconCross}<span>Libp2p connected: <span class='font-mono'>${couldConnect ? 'Yes' : provider.ConnectionError.replaceAll('\n', '<br>')}</span></span></div>`
                outHtml += couldConnect ? `<div class='flex items-center text-sm mb-1 ml-6'>${provider.DataAvailableOverBitswap.Found ? iconCheck : iconCross}<span>Bitswap Check: <span class='font-mono'>${provider.DataAvailableOverBitswap.Found ? 'Found' : 'Not found'}</span> ${provider.DataAvailableOverBitswap.Error || ''}</span></div>` : ''
            }
            if (hasHTTP) {
                const httpRes = provider.DataAvailableOverHTTP
                outHtml += `<div class='flex items-center text-sm mb-1'>${httpRes.Connected ? iconCheck : iconCross}<span>HTTP Connected: <span class='font-mono'>${httpRes.Connected ? 'Yes' : 'No'}</span></span></div>`
                outHtml += `<div class='flex items-center text-sm mb-1 ml-6'>${httpRes.Requested ? iconCheck : iconCross}<span>HTTP HEAD request: <span class='font-mono'>${httpRes.Requested ? 'Yes' : 'No'}</span></span></div>`
                outHtml += `<div class='flex items-center text-sm mb-1 ml-6'>${httpRes.Found ? iconCheck : iconCross}<span>HTTP Found: <span class='font-mono'>${httpRes.Found ? 'Yes' : 'No'}</span> ${provider.DataAvailableOverHTTP.Error || ''}</span></div>`
            }
            outHtml += (couldConnect && provider.ConnectionMaddrs) ? `<div class='text-xs text-gray-600 mt-2'><span class='font-bold'>Successful Connection Multiaddr${provider.ConnectionMaddrs.length > 1 ? 's' : ''}:</span><br><span class='font-mono block ml-4 break-all whitespace-break-spaces'>${provider.ConnectionMaddrs?.join('<br>') || ''}</span></div>` : ''
            outHtml += (provider.Addrs?.length > 0) ? `<div class='text-xs text-gray-600 mt-2'><span class='font-bold'>Peer Multiaddrs:</span><br><span class='font-mono block ml-4 break-all whitespace-break-spaces'>${provider.Addrs.join('<br>') || ''}</span></div>` : ''
            outHtml += `</div>`
        }
        outHtml += `</div>`
        return outHtml
    }
</script>
</body>
</html>
